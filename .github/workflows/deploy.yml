name: Deploy to Render

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x]

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # Setup Node.js
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      # Backend - Install dependencies
      - name: Install backend dependencies
        working-directory: ./backend
        run: npm install

      # Backend - Run linter (if available)
      - name: Lint backend code
        working-directory: ./backend
        run: npm run lint 2>/dev/null || echo "No linter configured"

      # Backend - Run tests (if available)
      - name: Run backend tests
        working-directory: ./backend
        run: npm test 2>/dev/null || echo "No tests configured"

      # Frontend - Install dependencies
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install

      # Frontend - Build
      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL || 'https://api.yourdomain.com/api' }}

      # Frontend - Run tests (if available)
      - name: Run frontend tests
        working-directory: ./frontend
        run: npm test 2>/dev/null || echo "No tests configured"

      # Create deployment artifact
      - name: Create deployment package
        run: |
          mkdir -p deployment
          cp -r backend deployment/
          cp -r frontend/dist deployment/public
          cp Dockerfile deployment/
          cp docker-compose.yml deployment/
          cd deployment && zip -r ../rent-management-deploy.zip . && cd ..

      # Upload artifact for deployment
      - name: Upload deployment artifact
        uses: actions/upload-artifact@v3
        with:
          name: rent-management-build
          path: rent-management-deploy.zip
          retention-days: 7

      # Deploy notification
      - name: Deployment Summary
        run: |
          echo "‚úÖ Build successful!"
          echo "üì¶ Artifact: rent-management-deploy.zip"
          echo "üöÄ Ready for deployment to Render/DigitalOcean"
          echo "üìã Next steps:"
          echo "   1. Download artifact from GitHub Actions"
          echo "   2. Follow DEPLOYMENT_GUIDE.md"
          echo "   3. Deploy to your chosen platform"

      # Optional: Notify Slack on failure
      - name: Notify Slack on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "‚ùå Rent Management build failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Build Failed* for ${{ github.repository }}\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                  }
                }
              ]
            }

  # Automatic deployment to Render (optional - requires setup)
  deploy-to-render:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Trigger Render deployment
        run: |
          if [ ! -z "${{ secrets.RENDER_DEPLOY_HOOK }}" ]; then
            curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}
            echo "‚úÖ Render deployment triggered"
          else
            echo "‚ö†Ô∏è RENDER_DEPLOY_HOOK not configured in secrets"
          fi

  # Automatic deployment to DigitalOcean (optional - requires setup)
  deploy-to-digitalocean:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Deploy to DigitalOcean via SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DO_SSH_PRIVATE_KEY }}
          DO_HOST: ${{ secrets.DO_HOST }}
          DO_USER: ${{ secrets.DO_USER }}
        run: |
          if [ ! -z "${{ secrets.DO_SSH_PRIVATE_KEY }}" ]; then
            mkdir -p ~/.ssh
            echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            ssh-keyscan -H $DO_HOST >> ~/.ssh/known_hosts
            ssh -i ~/.ssh/id_rsa $DO_USER@$DO_HOST 'cd /app && git pull && docker-compose up -d --build'
            echo "‚úÖ DigitalOcean deployment completed"
          else
            echo "‚ö†Ô∏è DigitalOcean secrets not configured"
          fi
